<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Document</title>
		<style>
			table {
				border-collapse: collapse;
			}
			td {
				border: 1px solid #bbb;
				text-align: center;
				line-height: 20px;
				width: 20px;
				height: 20px;
				background: #888;
			}
			td.opened {
				background: white;
			}
			td.flag {
				background: red;
			}
			td.question {
				background: orange;
			}
		</style>
	</head>
	<body>
		<form id="form">
			<input placeholder="가로 줄" id="row" size="5" />
			<input placeholder="세로 줄" id="cell" size="5" />
			<input placeholder="지뢰" id="mine" size="5" />
			<button>생성</button>
		</form>
		<div id="timer">0초</div>
		<table id="table">
			<tbody></tbody>
		</table>
		<div id="result"></div>
		<script>
			const $table = document.querySelector('#table');
			const $result = document.querySelector('#result');
			const $tbody = document.querySelector('tbody');
			const $timer = document.querySelector('#timer');
			const row = 10;
			const cell = 10;
			const mine = 10;
			const CODE = {
				NORMAL: -1, // 닫힌 칸(지뢰 없음)
				QUESTION: -2,
				FLAG: -3,
				QUESTION_MINE: -4,
				FLAG_MINE: -5,
				MINE: -6,
				OPENED: 0, // 0 이상이면 다모두 열린 칸
			};

			let openCount = 0;
			let startTime;
			// let data = [];

			//게임판 생성
			function plantMine() {
				const candidate = Array(row * cell)
					.fill()
					.map((num, i) => i);
				const shuffle = [];
				while (shuffle.length < mine) {
					const chosen = candidate.splice(
						Math.floor(Math.random() * candidate.length),
						1
					)[0];
					shuffle.push(chosen);
				}

				//이차원배열 생성
				const data = [];
				for (let i = 0; i < row; i++) {
					const rowData = [];
					for (let j = 0; j < cell; j++) {
						rowData.push(CODE.NORMAL);
					}
					data.push(rowData);
				}

				//위치값을 빼내는 방법
				shuffle.forEach((num, i) => {
					const ver = Math.floor(shuffle[i] / cell);
					const hor = shuffle[i] % cell;
					data[ver][hor] = CODE.MINE;
				});

				return data;
			}

			function countMines(rowIndex, cellIndex) {
				const mines = [CODE.MINE, CODE.QUESTION_MINE, CODE.FLAG_MINE];
				let i = 0;
				mines.includes(data[rowIndex + 1]?.[cellIndex - 1]) && i++;
				mines.includes(data[rowIndex + 1]?.[cellIndex]) && i++;
				mines.includes(data[rowIndex + 1]?.[cellIndex + 1]) && i++;
				mines.includes(data[rowIndex][cellIndex - 1]) && i++;
				mines.includes(data[rowIndex][cellIndex + 1]) && i++;
				mines.includes(data[rowIndex - 1]?.[cellIndex - 1]) && i++;
				mines.includes(data[rowIndex - 1]?.[cellIndex]) && i++;
				mines.includes(data[rowIndex - 1]?.[cellIndex + 1]) && i++;
				return i;
			}

			function openAround(rowIndex, cellIndex) {
				const target = $tbody.children[rowIndex]?.children[cellIndex];
				if (!target || target.classList.contains('opened')) {
					return;
				}
				const count = countMines(rowIndex, cellIndex);
				target.textContent = count || '';
				target.className = 'opened';
				data[rowIndex][cellIndex] = count;
				openCount++;
				if (count === 0) {
					setTimeout(() => {
						openAround(rowIndex + 1, cellIndex - 1);
						openAround(rowIndex + 1, cellIndex);
						openAround(rowIndex + 1, cellIndex + 1);
						openAround(rowIndex, cellIndex - 1);
						openAround(rowIndex, cellIndex + 1);
						openAround(rowIndex - 1, cellIndex - 1);
						openAround(rowIndex - 1, cellIndex);
						openAround(rowIndex - 1, cellIndex + 1);
					}, 0);
				}
				if (openCount === row * cell - mine) {
					const time = (new Date() - startTime) / 1000;
					setTimeout(() => {
						alert(`승리! ${time}초 걸렸어요`);
					}, 0);
				}
			}
			//좌클릭이벤트
			function onLeftClick(event) {
				event.preventDefault();
				const target = event.target;
				const rowIndex = event.target.parentNode.rowIndex;
				const cellIndex = event.target.cellIndex;
				const content = data[rowIndex][cellIndex];
				if (content === CODE.NORMAL) {
					//닫혀있는 상태일 때, 클릭을 하면
					openAround(rowIndex, cellIndex);
					// target.textContent = count || '';
					// target.className = 'opened';
					// data[rowIndex][cellIndex] = count;
				}
				//지뢰면
				else if (content === CODE.MINE) {
					target.className = 'opened';
					target.textContent = '펑!';
					$tbody.removeEventListener('contextmenu', onRightClick);
					$tbody.removeEventListener('click', onLeftClick);
				}
			}

			//우클릭이벤트
			function onRightClick(event) {
				event.preventDefault();
				const rowIndex = event.target.parentNode.rowIndex;
				const cellIndex = event.target.cellIndex;
				const content = data[rowIndex][cellIndex];
				switch (content) {
					case CODE.NORMAL:
						event.target.className = 'question';
						event.target.textContent = '?';
						data[rowIndex][cellIndex] = CODE.QUESTION;
						break;
					case CODE.QUESTION:
						event.target.className = 'flag';
						event.target.textContent = '!';
						data[rowIndex][cellIndex] = CODE.FLAG;
						break;
					case CODE.FLAG:
						event.target.className = '';
						event.target.textContent = '';
						data[rowIndex][cellIndex] = CODE.NORMAL;
						break;
					case CODE.MINE:
						event.target.className = 'question';
						event.target.textContent = '?';
						data[rowIndex][cellIndex] = CODE.QUESTION_MINE;
						break;
					case CODE.QUESTION_MINE:
						event.target.className = 'flag';
						event.target.textContent = '!';
						data[rowIndex][cellIndex] = CODE.FLAG_MINE;
						break;
					case CODE.FLAG_MINE:
						event.target.className = '';
						event.target.textContent = '';
						data[rowIndex][cellIndex] = CODE.MINE;
						break;
				}
			}

			//화면에 그려주기
			function drawTable() {
				startTime = new Date();

				data = plantMine();
				data.forEach((row, i) => {
					const $tr = document.createElement('tr');
					row.forEach((cell, i) => {
						const $td = document.createElement('td');
						$tr.append($td);
						if (cell === CODE.MINE) {
							$td.textContent = 'X';
						}
					});
					$tbody.append($tr);
				});
				$tbody.addEventListener('contextmenu', onRightClick);
				$tbody.addEventListener('click', onLeftClick);
			}

			drawTable();
		</script>
	</body>
</html>
